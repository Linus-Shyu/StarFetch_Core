name: Release

on:
  push:
    tags:
      - 'v*' # 当你推送形如 v0.2.2 的 tag 时触发

jobs:
  build:
    name: Build - ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
          - target: aarch64-unknown-linux-gnu
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-deb
        run: cargo install cargo-deb

      # 使用 Cross 编译以支持 ARM64 交叉编译
      - name: Install Cross
        run: cargo install cross --git https://github.com/cross-rs/cross.git

      - name: Build Debian Package
        run: |
          cross deb --target ${{ matrix.target }}
          # 将生成的包移动到一个统一的目录方便后续上传
          mkdir -p ./dist
          mv target/${{ matrix.target }}/debian/*.deb ./dist/

      - name: Archive Binary
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../dist/starfetch-${{ matrix.target }}.tar.gz starfetch
          cd ../../../

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: ./dist/*

  publish:
    name: Publish to Release & Cloudsmith
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-packages
          merge-multiple: true

      # 1. 发布到 GitHub Release
      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          files: ./all-packages/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. 推送到 Cloudsmith (可选，建议保留以支持 apt install)
      - name: Install Cloudsmith CLI
        run: pip install --upgrade cloudsmith-cli

      - name: Push to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          # 循环推送所有下载的 .deb 文件
          for file in ./all-packages/*.deb; do
            cloudsmith push deb starlakeai/starfetch/any-distro/any-version "$file"
          done
