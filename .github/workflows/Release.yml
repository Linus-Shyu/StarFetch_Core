name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ===================================================
  # Job 1: Linux æž„å»ºï¼ˆUbuntu/Debian .deb + é€šç”¨ tar.gzï¼‰
  # ===================================================
  build-linux:
    name: Build Linux (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu/Debian .debï¼šamd64ï¼ˆx86_64ï¼‰ã€arm64ï¼ˆaarch64ï¼‰
          - target: x86_64-unknown-linux-gnu
            deb: true
            use_cross: false
          - target: aarch64-unknown-linux-gnu
            deb: true
            use_cross: true
          # é€šç”¨ Linuxï¼ˆä»… tar.gzï¼Œå¦‚ Alpineï¼‰
          - target: x86_64-unknown-linux-musl
            deb: false
            use_cross: true

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Tools
        run: |
          cargo install cargo-deb
          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            curl -L https://github.com/cross-rs/cross/releases/download/v0.2.5/cross-x86_64-unknown-linux-musl.tar.gz | tar xz
            sudo mv cross /usr/local/bin/
          fi

      - name: Build and Collect Assets
        working-directory: StarFetch
        run: |
          set -e
          mkdir -p dist
          # ä»Žçˆ¶ç›®å½•å¤åˆ¶ LICENSE å’Œ README.md ç”¨äºŽ .deb æ‰“åŒ…
          cp ../LICENSE ../README.md .
          echo "ðŸ”¨ Building ${{ matrix.target }}..."
          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
          if [[ "${{ matrix.deb }}" == "true" ]]; then
            echo "ðŸ“¦ Packaging .deb..."
            cargo deb --target ${{ matrix.target }} --no-build --no-strip
            mv target/${{ matrix.target }}/debian/*.deb dist/
          fi
          name="starfetch-${{ matrix.target }}"
          cd "target/${{ matrix.target }}/release"
          tar -czvf "../../../dist/${name}.tar.gz" starfetch
          cd ../../../dist
          for file in *; do
            sha256sum "$file" | awk '{print $1}' > "$file.sha256"
          done

      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-linux-${{ matrix.target }}
          path: StarFetch/dist/*

  # ===================================================
  # Job 2: macOS æž„å»º
  # ===================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin
      - name: Build and Collect Assets
        working-directory: StarFetch
        run: |
          mkdir -p dist
          for target in x86_64-apple-darwin aarch64-apple-darwin; do
            cargo build --release --target "$target"
            
            filename="starfetch-$target.tar.gz"
            tar -czvf "dist/$filename" -C "target/$target/release" starfetch
            
            cd dist
            shasum -a 256 "$filename" | awk '{print $1}' > "$filename.sha256"
            cd ..
          done
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-macos
          path: StarFetch/dist/*

  # ===================================================
  # Job 3: Windows æž„å»º
  # ===================================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - name: Build and Collect Assets
        working-directory: StarFetch
        shell: pwsh
        run: |
          Set-Location -Path (Join-Path $env:GITHUB_WORKSPACE "StarFetch")
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          cargo build --release --target x86_64-pc-windows-msvc
          $zipName = "starfetch-x86_64-pc-windows-msvc.zip"
          $zipPath = "dist/$zipName"
          Compress-Archive -Path "target/x86_64-pc-windows-msvc/release/starfetch.exe" -DestinationPath $zipPath -Force
          (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLower() | Out-File -FilePath "$zipPath.sha256" -NoNewline

      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-windows
          path: StarFetch/dist/*

  # ===================================================
  # Job 4: å‘å¸ƒä¸Žåˆ†å‘
  # ===================================================
  publish:
    name: Publish Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets
          merge-multiple: true

      - name: Get Version
        id: get_ver
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # 1. GitHub Releaseï¼ˆåˆå¹¶å¤š job çš„ artifact åŽç»Ÿä¸€å±•å¹³åˆ° release-assets/ï¼‰
      - name: Flatten Release Assets
        run: |
          for dir in release-assets/StarFetch/dist release-assets/dist; do
            if [ -d "$dir" ]; then
              cp -a "$dir"/. release-assets/ 2>/dev/null || true
              rm -rf "$dir"
            fi
          done
          for sub in release-assets/artifacts-*; do
            [ -d "$sub" ] && cp -a "$sub"/. release-assets/ 2>/dev/null || true && rm -rf "$sub"
          done
      - name: Attach Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. Cloudsmith (APT) - ä¸å¯åœ¨ if ä¸­ä½¿ç”¨ secretsï¼Œæ”¹ä¸ºåœ¨ run å†…åˆ¤æ–­
      - name: Push to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          # åœ¨è„šæœ¬å†…éƒ¨åˆ¤æ–­ Key æ˜¯å¦å­˜åœ¨
          if [ -z "$CLOUDSMITH_API_KEY" ]; then
            echo "::warning::CLOUDSMITH_API_KEY is not set. Skipping Cloudsmith push."
            exit 0
          fi
          # å…¼å®¹ release-assets æˆ– release-assets/dist
          pip install --upgrade cloudsmith-cli
          for f in release-assets/*.deb release-assets/dist/*.deb; do
            [ -f "$f" ] && cloudsmith push deb starlakeai/starfetch/any-distro/any-version "$f" || true
          done

      # 3. Homebrew Tap - ä¸å¯åœ¨ if ä¸­ä½¿ç”¨ secretsï¼Œæ”¹ä¸ºåœ¨ run å†…åˆ¤æ–­
      - name: Update Homebrew
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::warning::HOMEBREW_TAP_TOKEN is not set. Skipping Homebrew update."
            exit 0
          fi
          # å…¼å®¹ release-assets æˆ– release-assets/distï¼ˆä¸Šä¸€æ­¥å·² flattenï¼Œæ­¤å¤„ç”¨ release-assets/ï¼‰
          V=${{ steps.get_ver.outputs.version }}
          ARM_SHA=$(cat release-assets/starfetch-aarch64-apple-darwin.tar.gz.sha256 2>/dev/null || cat release-assets/dist/starfetch-aarch64-apple-darwin.tar.gz.sha256)
          X64_SHA=$(cat release-assets/starfetch-x86_64-apple-darwin.tar.gz.sha256 2>/dev/null || cat release-assets/dist/starfetch-x86_64-apple-darwin.tar.gz.sha256)
          
          git clone https://x-access-token:$GH_TOKEN@github.com/Linus-Shyu/homebrew-tap.git /tmp/tap
          cd /tmp/tap
          mkdir -p Formula
          
          cat > Formula/starfetch.rb << EOF
          class Starfetch < Formula
            desc "A fast and stylish system information fetch tool"
            homepage "https://github.com/Linus-Shyu/StarFetch_Core"
            version "$V"
            license "MIT"
            
            if Hardware::CPU.arm?
              url "https://github.com/${{ github.repository }}/releases/download/v$V/starfetch-aarch64-apple-darwin.tar.gz"
              sha256 "$ARM_SHA"
            else
              url "https://github.com/${{ github.repository }}/releases/download/v$V/starfetch-x86_64-apple-darwin.tar.gz"
              sha256 "$X64_SHA"
            end

            def install
              bin.install "starfetch"
            end
          end
          EOF
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add . && git commit -m "starfetch v$V" && git push || true

      # 4. Winget - ä¸å¯åœ¨ if ä¸­ä½¿ç”¨ secretsï¼Œæ”¹ä¸ºåœ¨ run å†…åˆ¤æ–­
      - name: Update Winget
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::warning::HOMEBREW_TAP_TOKEN is not set. Skipping Winget update."
            exit 0
          fi
          
          V=${{ steps.get_ver.outputs.version }}
          SHA=$(cat release-assets/starfetch-x86_64-pc-windows-msvc.zip.sha256 2>/dev/null || cat release-assets/dist/starfetch-x86_64-pc-windows-msvc.zip.sha256)
          URL="https://github.com/${{ github.repository }}/releases/download/v$V/starfetch-x86_64-pc-windows-msvc.zip"
          
          git clone https://x-access-token:$GH_TOKEN@github.com/Linus-Shyu/winget-pkgs.git /tmp/winget
          cd /tmp/winget
          
          MANIFEST_DIR="manifests/l/Linus-Shyu/StarFetch/$V"
          mkdir -p "$MANIFEST_DIR"
          
          cat > "$MANIFEST_DIR/Linus-Shyu.StarFetch.installer.yaml" << EOF
          PackageIdentifier: Linus-Shyu.StarFetch
          PackageVersion: $V
          InstallerType: zip
          Installers:
            - Architecture: x64
              InstallerUrl: $URL
              InstallerSha256: $SHA
              NestedInstallerType: portable
              NestedInstallerFiles:
                - RelativeFilePath: starfetch.exe
                  PortableCommandAlias: starfetch
          ManifestType: installer
          ManifestVersion: 1.4.0
          EOF
          
          cat > "$MANIFEST_DIR/Linus-Shyu.StarFetch.locale.en-US.yaml" << EOF
          PackageIdentifier: Linus-Shyu.StarFetch
          PackageVersion: $V
          PackageLocale: en-US
          Publisher: Linus Shyu
          PackageName: StarFetch
          License: MIT
          ShortDescription: A fast and stylish system information fetch tool
          ManifestType: defaultLocale
          ManifestVersion: 1.4.0
          EOF
          
          cat > "$MANIFEST_DIR/Linus-Shyu.StarFetch.version.yaml" << EOF
          PackageIdentifier: Linus-Shyu.StarFetch
          PackageVersion: $V
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.4.0
          EOF
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add . && git commit -m "StarFetch v$V" && git push || true

      # 5. Winget - è‡ªåŠ¨å‘å®˜æ–¹ microsoft/winget-pkgs æ PRï¼ˆéœ€äººå·¥ review åˆå¹¶ï¼‰
      - name: Open PR to microsoft/winget-pkgs
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::warning::HOMEBREW_TAP_TOKEN is not set. Skipping winget-pkgs PR."
            exit 0
          fi
          V=${{ steps.get_ver.outputs.version }}
          ASSETS="${{ github.workspace }}/release-assets"
          SHA=$(cat "$ASSETS/starfetch-x86_64-pc-windows-msvc.zip.sha256" 2>/dev/null || cat "$ASSETS/dist/starfetch-x86_64-pc-windows-msvc.zip.sha256" 2>/dev/null || true)
          if [ -z "$SHA" ]; then
            echo "::warning::Windows zip sha256 not found, skipping winget-pkgs PR."
            exit 0
          fi
          URL="https://github.com/${{ github.repository }}/releases/download/v$V/starfetch-x86_64-pc-windows-msvc.zip"
          BRANCH="starfetch-v$V"
          git clone --depth 1 https://github.com/microsoft/winget-pkgs.git /tmp/winget-upstream
          cd /tmp/winget-upstream
          git remote add fork "https://x-access-token:${GH_TOKEN}@github.com/Linus-Shyu/winget-pkgs.git"
          git fetch origin
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@') || DEFAULT_BRANCH="master"
          git checkout -b "$BRANCH" "origin/$DEFAULT_BRANCH"
          MANIFEST_DIR="manifests/l/Linus-Shyu/StarFetch/$V"
          mkdir -p "$MANIFEST_DIR"
          cat > "$MANIFEST_DIR/Linus-Shyu.StarFetch.installer.yaml" << EOF
          PackageIdentifier: Linus-Shyu.StarFetch
          PackageVersion: $V
          InstallerType: zip
          Installers:
            - Architecture: x64
              InstallerUrl: $URL
              InstallerSha256: $SHA
              NestedInstallerType: portable
              NestedInstallerFiles:
                - RelativeFilePath: starfetch.exe
                  PortableCommandAlias: starfetch
          ManifestType: installer
          ManifestVersion: 1.4.0
          EOF
          cat > "$MANIFEST_DIR/Linus-Shyu.StarFetch.locale.en-US.yaml" << EOF
          PackageIdentifier: Linus-Shyu.StarFetch
          PackageVersion: $V
          PackageLocale: en-US
          Publisher: Linus Shyu
          PackageName: StarFetch
          License: MIT
          ShortDescription: A fast and stylish system information fetch tool
          ManifestType: defaultLocale
          ManifestVersion: 1.4.0
          EOF
          cat > "$MANIFEST_DIR/Linus-Shyu.StarFetch.version.yaml" << EOF
          PackageIdentifier: Linus-Shyu.StarFetch
          PackageVersion: $V
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.4.0
          EOF
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add . && git diff --staged --quiet || git commit -m "Add Linus-Shyu.StarFetch $V"
          git push fork "$BRANCH" || true
          export GH_TOKEN
          gh pr create --repo microsoft/winget-pkgs --head "Linus-Shyu:$BRANCH" --base "$DEFAULT_BRANCH" \
            --title "Add Linus-Shyu.StarFetch $V" \
            --body "Automated PR from [StarFetch_Core](https://github.com/${{ github.repository }}) release [v$V](https://github.com/${{ github.repository }}/releases/tag/v$V)." \
            || echo "::notice::PR may already exist or creation failed."